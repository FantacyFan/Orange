<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link href="http://getbootstrap.com/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="http://getbootstrap.com/examples/justified-nav/justified-nav.css" rel="stylesheet">
  <script src="http://d3js.org/d3.v3.min.js"></script>
</head>
<body>
<svg id="visualisation" width="1000" height="500"></svg>

<div class="container">
  <button id="文化娱乐体育" onClick="reply_click(this.id)">文化娱乐体育</button>
  <button id="电子商务" onClick="reply_click(this.id)">电子商务</button>
</div>


<script>

  

var getData;
var tempData = [];

var allCombinations = [];
var roundFreqData = [];

var vis = d3.select("#visualisation"),
    width = 1000,
    height = 500,
    margins = {
        top: 20,
        right: 20,
        bottom: 20,
        left: 50
    };

var min,
    max;

var id = '';

var filterCombinations = [];





d3.json("orange.json", function(error, data) {
    //error checking
    if(error){
      console.log(error);
    }

  getData = data;


  var year = [],
      count = [],
      domain = [],
      count2 = [];



  var frequency = {};  // array of frequency.
  var maxCount = 0;  // holds the max frequency.
  var result;   // holds the max frequency element.


  getData.forEach(function(d){
    d.combinations.forEach(function(combination){
      allCombinations.push(combination);
    });
  });
  
  allCombinations.forEach(function(d) {
    d.year = d.date.substring(0, 4);
    year.push(d.year);
    domain.push(d.domain);
  });

  // console.log(domain);

  function contains(a, obj) {
    var i = a.length;
    while (i--) {
       if (a[i] === obj) {
           return true;
       }
    }
    return false;
  }

  // if([domain].includes("制造业")){
  //   console.log("ok");
  // }else{
  //   console.log("haha");
  // }  


  // if(domainCount.contains("制造业")){
  //   console.log("ok");
  // }

  // console.log(domainCount);

  // var domainNum = Object.keys(domains).length;
  // console.log(domainNum);

  Array.prototype.contains = function(v) {
    for(var i = 0; i < this.length; i++) {
        if(this[i] === v) return true;
    }
    return false;
  };

  Array.prototype.unique = function() {
      var arr = [];
          console.log(this.length);

      for(var i = 0; i < this.length; i++) {
          if(!arr.contains(this[i])) {
              arr.push(this[i]);
              // console.log(this[i]);
          }
          // console.log(i);
      }
      return arr; 
  }

  

  // console.log(year);

  
  for(var y in year) {
        frequency[year[y]]=(frequency[year[y]] || 0)+1; // increment frequency.
        if(frequency[year[y]] > maxCount) { // is this frequency > max so far ?
                maxCount = frequency[year[y]];  // update max.
                result = year[y];          // update result.
        }
  }


  var counts = {};

  var domainCounts = {};

  for(var i = 0; i< year.length; i++) {
      var num = year[i];
      counts[num] = counts[num] ? counts[num]+1 : 1;
  }


  for(var i = 0; i< year.length; i++) {
      count.push(counts[i]);
  }



  for(var i = 0; i< domain.length; i++) {
      var num = domain[i];
      if(num){
        domainCounts[num] = domainCounts[num] ? domainCounts[num]+1 : 1;
      }
  }


  for(var i = 0; i< domain.length; i++) {
    if(domain[i]){
      count2.push(domainCounts[i]);
    }
  }

  // console.log(domain.length);

  // console.log(counts);
  // console.log(domainCounts);

  var domainLength = Object.keys(domainCounts).length;
  // console.log(domainLength);

  allCombinations.forEach(function(d) {
    d.count = counts[d.year];
    d.year = +d.year;
  });

  allCombinations.sort(function(a,b) {
    return d3.ascending(a.year, b.year);
  });

  
  min = Math.min.apply(null, year),
  max = Math.max.apply(null, year);


  var xScale = d3.scale.linear()
        .range([margins.left, width - margins.right])
        .domain([min,max]),

      yScale = d3.scale.linear()
        .range([height - margins.top, margins.bottom])
        .domain([0,(maxCount/domainLength)*1.5]),

      xAxis = d3.svg.axis()
        .scale(xScale),
  
      yAxis = d3.svg.axis()
          .scale(yScale)
          .orient("left");

      vis.append("svg:g")
          .attr("transform", "translate(0," + (height - margins.bottom) + ")")
          .style({ 'stroke': 'Black', 'fill': 'none', 'stroke-width': '1px'})
          .call(xAxis);

      vis.append("svg:g")
          .attr("transform", "translate(" + (margins.left) + ",0)")
          .style({ 'stroke': 'Black', 'fill': 'none', 'stroke-width': '1px'})
          .call(yAxis);

      allCombinations.forEach(function(d) {
      if (d.domain == id) {
        filterCombinations.push(d);
      }
    });

      var lineGen = d3.svg.line()
          .x(function(d) {
            return xScale(d.year);
          })
          .y(function(d) {
            return yScale(d.count/domainLength);
          });

      vis.append('svg:path')
          .attr('d', lineGen(allCombinations))
          .attr('stroke', 'green')
          .attr('stroke-width', 1)
          .attr('fill', 'none');

});


  
  function reply_click(id){
    filterCombinations = [];
    allCombinations.forEach(function(d) {
      if (d.domain == id) {
        filterCombinations.push(d);
      }
    });
    console.log(filterCombinations);
  }

  


</script>




</body>
</html>